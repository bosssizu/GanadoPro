<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>GanadoPro • v31 ultra</title>
<style>
:root{--bg:#0b1220;--ink:#e5e7eb;--muted:#9ca3af;--card:#0f172a;--line:#1f2937;--brand:#22d3ee}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}.pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);background:#0b1325}
.card{background:#0f172a;border:1px solid var(--line);border-radius:16px;padding:14px}.btn{background:#e5e7eb;color:#0b1220;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
#dropArea.drag{outline:2px dashed var(--brand);outline-offset:4px}.bar{height:12px;background:#111827;border-radius:999px;overflow:hidden}.bar>i{display:block;height:12px;width:0;background:#ef4444;border-radius:999px}
.preview{max-width:100%;border-radius:12px;border:1px solid var(--line)}
</style>
<script>
(function(){function byId(id){return document.getElementById(id)}function getApi(){try{return localStorage.getItem('ganadopro.apiBase')||'/api'}catch(e){return'/api'}}
function saveApi(v){try{localStorage.setItem('ganadopro.apiBase',v)}catch(e){}}function setBadge(text,ok){var el=byId('health');if(!el)return;el.textContent=text;el.style.color=ok?'#86efac':'#fecaca'}
async function health(){var base=getApi();var url=(base||'/api').replace(/\/$/,'')+'/health';try{const ctl=new AbortController();const t=setTimeout(()=>ctl.abort(),3500);const r=await fetch(url,{signal:ctl.signal});clearTimeout(t);const j=await r.json();setBadge(j.hasKey?('API: OK ('+(j.model||'')+')'):'API: sin llave',j.hasKey);byId('health').href=url}catch(e){setBadge('API: error',false);byId('health').href=url}}
window.addEventListener('DOMContentLoaded',function(){var cfg=byId('cfgApi');if(cfg){cfg.onclick=function(){var cur=getApi();var val=prompt('Base de API (ej: /api o https://tuapp.vercel.app/api)',cur);if(!val)return;saveApi(val);health();alert('API base guardada: '+val)}};var rst=byId('resetApi');if(rst){rst.onclick=function(){saveApi('/api');alert('API base restablecida a /api');health();}};var file=byId('file');var btn=byId('btnUpload');var lbl=byId('lblUpload');if(btn&&file)btn.onclick=function(){file.click()};if(lbl&&file)lbl.onclick=function(){file.click()};var drop=byId('dropArea');if(drop&&file){['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag')}));['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag')}));drop.addEventListener('drop',e=>{var fs=e.dataTransfer&&e.dataTransfer.files;if(fs&&fs.length){file.files=fs;file.dispatchEvent(new Event('change'))}})}health();});})();</script>
</head>
<body>
<div class="wrap">
  <div style="display:flex;gap:8px;align-items:center">
    <a class="pill" id="health" href="#">API: verificando…</a>
    <button id="cfgApi" class="pill" type="button">Configurar API</button>
    <button id="resetApi" class="pill" type="button">Reset API</button>
  </div>
  <div class="card" id="dropArea" style="margin-top:12px">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label for="file" class="btn" id="lblUpload">Subir imagen</label>
      <button id="btnUpload" class="btn ghost" type="button">Elegir</button>
      <input id="file" type="file" accept="image/*" capture="environment" style="display:none">
      <input id="fileNative" type="file" accept="image/*" style="background:#0b1325;color:#e5e7eb;border:1px solid #1f2937;border-radius:8px;padding:8px">
      <div id="status" class="pill">Listo para cargar</div>
    </div>
    <div id="imgWrap" style="margin-top:10px;display:none"><img id="preview" class="preview" alt="preview"></div>
  </div>
</div>
<script>
(function(){
  const $=(s)=>document.querySelector(s);
  const state={ apiBase: localStorage.getItem('ganadopro.apiBase') || '/api' };
  const status=$('#status'), imgWrap=$('#imgWrap'), preview=$('#preview');
  const fileHidden=$('#file'), fileNative=$('#fileNative');
  function bytes(n){return (n/1024/1024).toFixed(2)+' MB'}
  async function fileToDataURL(file){return await new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}
  async function compress(file,maxSide=1400,quality=0.8){const dataUrl=await fileToDataURL(file);const img=new Image();img.src=dataUrl;await new Promise((res,rej)=>{img.onload=res;img.onerror=()=>rej(new Error('No se pudo decodificar imagen'))});const scale=Math.min(1,maxSide/Math.max(img.naturalWidth,img.naturalHeight));const w=Math.round(img.naturalWidth*scale),h=Math.round(img.naturalHeight*scale);const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);const out=c.toDataURL('image/jpeg',quality);const b64len=out.length-'data:image/jpeg;base64,'.length;return {dataUrl:out, bytes:Math.floor(b64len*3/4)};}
  function gaugeColor(score){ if(score<45) return '#ef4444'; if(score<58) return '#f59e0b'; if(score<72) return '#eab308'; if(score<90) return '#10b981'; return '#22c55e'; }
  function badgeClass(v){ if(v==='Excelente'||v==='Bueno') return 'badge ok'; if(v==='Regular') return 'badge warn'; return 'badge bad'; }
  async function analyze(file){
    try{
      status.textContent='Procesando imagen…';
      const comp=await compress(file,1400,0.8);
      status.textContent='Analizando ('+bytes(file.size)+' → ~'+bytes(comp.bytes)+')…';
      const resp=await fetch((state.apiBase||'/api').replace(/\/$/,'')+'/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageDataUrl:comp.dataUrl})});
      if(!resp.ok){ const txt=await resp.text(); throw new Error('API '+resp.status+': '+txt.slice(0,160)); }
      const r=await resp.json();
      imgWrap.style.display='block';
      status.textContent='Listo';
    }catch(err){ status.textContent='Error: '+(err&&err.message?err.message:err); }
  }
  function startWithFile(f){
    if(!f){ status.textContent='No seleccionaste imagen'; return; }
    if(!/^image\//i.test(f.type)){ status.textContent='Archivo no es imagen'; return; }
    const url=URL.createObjectURL(f); imgWrap.style.display='block'; preview.src=url; requestAnimationFrame(()=> URL.revokeObjectURL(url));
    status.textContent='Imagen seleccionada: '+(f.name||'(captura)'); analyze(f);
  }
  fileHidden.addEventListener('change',(e)=> startWithFile(e.target.files && e.target.files[0]));
  fileNative.addEventListener('change',(e)=> startWithFile(e.target.files && e.target.files[0]));
})();</script>
</body></html>
