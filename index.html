<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GanadoPro • Evaluación avanzada (Vanilla)</title>
  <style>
    :root{
      --bg:#f6f7fb;--ink:#0f172a;--muted:#64748b;--card:#ffffff;--line:#e2e8f0;
      --ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--brand:#0ea5e9;
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin:8px 0 12px}
    header .logo{width:40px;height:40px;border-radius:12px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    nav{display:flex;gap:8px;margin-bottom:12px}
    .tab{background:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:999px;cursor:pointer;font-size:14px}
    .tab.active{background:#111827;color:#fff;border-color:#111827}
    .grid{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 3px rgba(0,0,0,.04);padding:16px}
    .btn{background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
    .btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .btn.warn{background:#ef4444}
    label{font-size:12px;color:var(--muted)}
    input, select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font-size:14px;color:var(--ink);background:#fff}
    img.preview{max-width:100%;border-radius:12px;border:1px solid var(--line);background:#fff}
    .stat{display:flex;justify-content:space-between;padding:4px 0;border-top:1px dashed var(--line);font-size:14px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#f8fafc;font-size:12px;color:#334155}
    .badge.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .badge.warn{background:#fffbeb;color:#92400e;border-color:#fde68a}
    .badge.bad{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .bar{height:12px;background:#e2e8f0;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:12px;background:var(--ok);width:0}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .errbox{white-space:pre-wrap;background:#fef2f2;color:#991b1b;border:1px solid #fecaca;border-radius:12px;padding:10px;font-size:12px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <div style="font-weight:700">GanadoPro · Evaluación avanzada (Vanilla)</div>
      <div class="muted">Morfología + Veredicto (muy malo → excelente) + Precios</div>
    </div>
  </header>

  <nav>
    <button class="tab active" data-tab="analizar">Analizar</button>
    <button class="tab" data-tab="reporte">Reporte</button>
    <button class="tab" data-tab="precios">Precios</button>
    <button class="tab" data-tab="dataset">Dataset</button>
    <button class="tab" data-tab="ajustes">Ajustes</button>
  </nav>

  <section id="analizar" class="row">
    <div class="grid">
      <div class="card">
        <div style="font-weight:600;margin-bottom:8px">Datos del animal</div>
        <div class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr))">
          <div><label>Sexo</label><select id="sex">
            <option value="macho">Macho</option><option value="hembra">Hembra</option></select></div>
          <div><label>Categoría</label><select id="category">
            <option value="ternero">Ternero</option><option value="novillo">Novillo</option>
            <option value="toro">Toro</option><option value="vaquilla">Vaquilla</option><option value="vaca_descarte">Vaca de descarte</option>
          </select></div>
          <div><label>Edad (meses)</label><input type="number" id="age" value="18" min="0"></div>
          <div><label>Peso (kg)</label><input type="number" id="weight" value="320" min="20"></div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:600;margin-bottom:8px">Imagen lateral</div>
        <div class="row2">
          <div><img id="preview" class="preview" alt="preview" style="display:none"></div>
          <div class="grid">
            <label class="btn ghost" for="fileSide">Subir imagen</label>
            <input id="fileSide" type="file" accept="image/*" style="display:none">
            <button id="btnAnalyze" class="btn" disabled>Analizar con IA</button>
          </div>
        </div>
      </div>

      <div id="analysisCard" class="card" style="display:none">
        <div style="font-weight:600;margin-bottom:8px">Informe morfológico</div>
        <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));gap:16px">
          <div>
            <div class="stat"><div>Largo/Alzada</div><div id="m_bodyLenToHeight">–</div></div>
            <div class="stat"><div>Prof. abdomen/Alzada</div><div id="m_bellyDepthRatio">–</div></div>
            <div class="stat"><div>Ángulo corvejón (°)</div><div id="m_hockAngleDeg">–</div></div>
            <div class="stat"><div>Desv. de dorso</div><div id="m_toplineDeviation">–</div></div>
            <div class="stat"><div>Pendiente de grupa</div><div id="m_rumpSlope">–</div></div>
          </div>
          <div>
            <div class="stat"><div>BCS (1–5)</div><div id="m_bcs">–</div></div>
            <div style="margin-top:8px;color:var(--muted);font-size:12px">Banderas</div>
            <ul id="flags" style="margin:6px 0 0 18px;padding:0;list-style:disc"></ul>
            <div id="diseasesWrap" style="margin-top:8px;display:none">
              <div style="color:var(--muted);font-size:12px">Posibles enfermedades visibles</div>
              <ul id="diseases" style="margin:6px 0 0 18px;padding:0;list-style:disc"></ul>
            </div>
          </div>
          <div>
            <div style="font-weight:600;margin-bottom:6px">Aptitud para engorda</div>
            <div class="bar"><i id="scoreBar"></i></div>
            <div class="muted" style="margin-top:6px">Score: <span id="scoreNum">–</span>/100</div>
            <div style="margin-top:6px">Veredicto: <span id="verdict" class="badge">–</span></div>
            <div style="margin-top:10px" class="muted">Raza/Tipo: <span id="breedTop" style="color:#111">–</span></div>
          </div>
        </div>
      </div>

    </div>

    <aside class="grid">
      <div class="card">
        <div style="font-weight:600;margin-bottom:6px">Estimación de precio (subasta)</div>
        <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr))">
          <div><label>Peso (kg)</label><input id="priceWeight" type="number" value="320"></div>
          <div><label>Categoría</label><select id="priceCategory">
            <option value="ternero">Ternero</option><option value="novillo">Novillo</option>
            <option value="toro">Toro</option><option value="vaquilla">Vaquilla</option><option value="vaca_descarte">Vaca de descarte</option>
          </select></div>
          <div><label>Sexo</label><select id="priceSex"><option value="macho">Macho</option><option value="hembra">Hembra</option></select></div>
        </div>
        <div style="margin-top:8px">
          <div class="stat"><div>CRC/kg (P25)</div><div id="p_p25">–</div></div>
          <div class="stat"><div>CRC/kg (P50)</div><div id="p_p50">–</div></div>
          <div class="stat"><div>CRC/kg (P75)</div><div id="p_p75">–</div></div>
          <div class="stat"><div>Total bajo</div><div id="p_low">–</div></div>
          <div class="stat"><div>Total medio</div><div id="p_mid">–</div></div>
          <div class="stat"><div>Total alto</div><div id="p_high">–</div></div>
          <div class="muted" id="p_sample" style="margin-top:6px">Muestra usada: –</div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:600;margin-bottom:6px">Acciones</div>
        <div class="grid">
          <button id="btnReanalyze" class="btn" disabled>Reanalizar</button>
          <button id="btnGotoPrecios" class="btn ghost">Ir a Precios</button>
          <button id="btnGotoDataset" class="btn ghost">Cargar Dataset</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:600;margin-bottom:6px">Logs / Errores</div>
        <div id="logbox" class="errbox">Sin errores.</div>
      </div>
    </aside>
  </section>

  <section id="reporte" style="display:none" class="card">
    <div style="font-weight:600;margin-bottom:8px">Reporte consolidado</div>
    <div id="reportContent" class="muted">Genera un análisis primero.</div>
  </section>

  <section id="precios" style="display:none" class="card">
    <div style="font-weight:600;margin-bottom:8px">Estimador de precios por subasta (con tu dataset)</div>
    <div class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr))">
      <div><label>Peso (kg)</label><input id="w2" type="number" value="320"></div>
      <div><label>Categoría</label><select id="c2">
        <option value="ternero">Ternero</option><option value="novillo">Novillo</option>
        <option value="toro">Toro</option><option value="vaquilla">Vaquilla</option><option value="vaca_descarte">Vaca de descarte</option>
      </select></div>
      <div><label>Sexo</label><select id="s2"><option value="macho">Macho</option><option value="hembra">Hembra</option></select></div>
    </div>
    <div id="priceOut" style="margin-top:10px" class="muted">Carga un dataset en la pestaña “Dataset”.</div>
  </section>

  <section id="dataset" style="display:none" class="card">
    <div style="font-weight:600;margin-bottom:8px">Tu dataset de subastas (CSV / OCR)</div>
    <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr))">
      <label class="btn ghost" for="csv">Subir CSV</label><input id="csv" type="file" accept=".csv,text/csv" style="display:none">
      <label class="btn ghost" for="imgs">Subir imágenes (JPG/PNG)</label><input id="imgs" type="file" accept="image/*" multiple style="display:none">
      <button id="btnClear" class="btn ghost">Borrar dataset</button>
    </div>
    <div id="dsCount" class="muted" style="margin-top:8px">Registros cargados: 0</div>
    <div class="muted" style="margin-top:6px">CSV esperado: <code>date,category,sex,age_months,weight_kg,price_total_crc,location</code></div>
  </section>

  <section id="ajustes" style="display:none" class="card">
    <div style="font-weight:600;margin-bottom:8px">Ajustes</div>
    <div class="grid" style="grid-template-columns:1fr 160px">
      <div><label>API base</label><input id="apiBase" placeholder="/api o https://tu-app.vercel.app/api"></div>
      <div><button id="btnSaveApi" class="btn">Guardar</button></div>
    </div>
    <div class="muted" style="margin-top:6px">Actual: <code id="apiBaseCur">/api</code></div>
  </section>

  <footer class="muted" style="margin-top:18px">© <span id="year"></span> GanadoPro. Este software no reemplaza el criterio de un MVZ.</footer>
</div>

<script>
(function(){
  // ---------- Helpers UI ----------
  const $ = (s)=>document.querySelector(s);
  const nf = new Intl.NumberFormat('es-CR');
  function log(msg){ const box=$('#logbox'); const now=new Date().toLocaleTimeString(); box.textContent = '['+now+'] '+msg; }
  window.addEventListener('error', (e)=>{ log('JS Error: '+e.message+' @ '+(e.filename||'')+':'+(e.lineno||'')); });
  window.addEventListener('unhandledrejection', (e)=>{ log('Promise Rejection: '+(e.reason?.message||e.reason||'')); });

  // ---------- Tabs ----------
  const tabs=[...document.querySelectorAll('.tab')];
  function showTab(id){
    ['analizar','reporte','precios','dataset','ajustes'].forEach(x=> $('#'+x).style.display = (x===id)? (x==='analizar'?'grid':'block') : 'none');
    tabs.forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
  }
  tabs.forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));
  showTab('analizar');

  // ---------- State ----------
  const state = {
    apiBase: localStorage.getItem('ganadopro.apiBase') || '/api',
    dataset: [],
    result: null,
  };
  $('#apiBase').value = state.apiBase; $('#apiBaseCur').textContent = state.apiBase;

  // ---------- Inputs ----------
  const sexSel = $('#sex'), catSel=$('#category'), ageInp=$('#age'), wInp=$('#weight');
  const priceWeight=$('#priceWeight'), priceCategory=$('#priceCategory'), priceSex=$('#priceSex');

  // ---------- File handling ----------
  const fileSide = $('#fileSide'), preview=$('#preview'), btnAnalyze=$('#btnAnalyze'), btnReanalyze=$('#btnReanalyze');
  fileSide.addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f){ preview.style.display='none'; btnAnalyze.disabled=true; btnReanalyze.disabled=true; return; }
    const url = URL.createObjectURL(f); preview.src=url; preview.style.display='block';
    btnAnalyze.disabled=false; btnReanalyze.disabled=false;
    state.file = f;
  });
  $('#btnGotoPrecios').onclick = ()=> showTab('precios');
  $('#btnGotoDataset').onclick = ()=> showTab('dataset');

  async function toDataURL(file){ return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

  // ---------- Scoring ----------
  function clamp(n,min,max){ return Math.min(max, Math.max(min,n)); }
  function fmt(n,d=2){ return Number.isFinite(n)? n.toFixed(d) : '–'; }
  function scoreFattening({ metrics, bcs, sex, ageMonths, category }){
    let score=0, totalW=0;
    if(Number.isFinite(bcs)){ const dist=Math.abs(bcs-3.0); let s=100-clamp(dist*40,0,100); const w=0.28; score+=s*w; totalW+=w; }
    if(Number.isFinite(metrics?.bodyLenToHeight)){ const x=metrics.bodyLenToHeight; let s=100-Math.abs(x-1.65)*180; s=clamp(s,0,100); const w=0.18; score+=s*w; totalW+=w; }
    if(Number.isFinite(metrics?.hockAngleDeg)){ const x=metrics.hockAngleDeg; let s=100-Math.abs(x-145)*4; s=clamp(s,0,100); const w=0.18; score+=s*w; totalW+=w; }
    if(Number.isFinite(metrics?.toplineDeviation)){ const x=metrics.toplineDeviation; let s=100- clamp((x-0.08),0,0.42)*(100/0.42); s=clamp(s,0,100); const w=0.14; score+=s*w; totalW+=w; }
    if(Number.isFinite(metrics?.rumpSlope)){ const x=Math.abs(metrics.rumpSlope); let s=100- clamp(Math.max(0,x-0.12),0,0.3)*(100/0.3); s=clamp(s,0,100); const w=0.10; score+=s*w; totalW+=w; }
    if(Number.isFinite(ageMonths)){ let adj=1; if(category==='novillo'){ if(ageMonths<8||ageMonths>30) adj=0.9; } else if(category==='ternero'){ adj=0.85; } else if(category==='vaquilla'||category==='vaca_descarte'){ adj=0.9; } else if(category==='toro'){ adj=0.85; } const w=0.12; score+=100*adj*w; totalW+=w; }
    const final = totalW? (score/totalW) : 0; return clamp(Math.round(final),0,100);
  }
  function verdictCategory(score){
    if(score>=85) return {label:'Excelente', cls:'ok'};
    if(score>=70) return {label:'Bueno', cls:'ok'};
    if(score>=55) return {label:'Regular', cls:'warn'};
    if(score>=40) return {label:'Malo', cls:'bad'};
    return {label:'Muy malo', cls:'bad'};
  }
  function mapFlags(flags=[]){
    const dict={ hock_angle_closed:'Corvejón cerrado: vigilar claudicación', hock_angle_watch:'Ángulo de corvejón subóptimo',
      topline_curved:'Dorso curvo: revisar dolor/condición', steep_rump:'Grupa muy caída: impacto locomoción/parto', underweight:'Condición corporal baja' };
    return flags.map(f=> dict[f]||f);
  }

  // ---------- Dataset + Pricing ----------
  function safeNum(v){ const n=Number(String(v).replace(/[^0-9.-]/g,'')); return Number.isFinite(n)?n:NaN; }
  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length); if(!lines.length) return [];
    const headers = lines[0].split(',').map(h=>h.trim());
    return lines.slice(1).map(line=>{
      const cells=line.split(',');
      const obj={}; headers.forEach((h,i)=> obj[h]=(cells[i]??'').trim());
      obj.price_total_crc = safeNum(obj.price_total_crc);
      obj.weight_kg = safeNum(obj.weight_kg);
      obj.age_months = safeNum(obj.age_months);
      obj.price_per_kg = (Number.isFinite(obj.price_total_crc)&&Number.isFinite(obj.weight_kg)&&obj.weight_kg>0)? (obj.price_total_crc/obj.weight_kg) : NaN;
      obj.category = (obj.category||'').toLowerCase(); obj.sex=(obj.sex||'').toLowerCase();
      return obj;
    });
  }
  function estimatePrice(dataset, category, sex, weightKg){
    if(!Array.isArray(dataset)||!dataset.length||!Number.isFinite(weightKg)) return null;
    const sameCat = dataset.filter(r=> (r.category||'')===category);
    const sameSex = sameCat.filter(r=> (r.sex||'')===sex);
    let window=0.12, pool=sameSex;
    while(pool.length<15 && window<=0.35){
      pool = sameSex.filter(r=> Number.isFinite(r.weight_kg) && Math.abs(r.weight_kg-weightKg)/weightKg<=window);
      window+=0.05;
    }
    if(pool.length===0) pool = sameSex.length? sameSex : sameCat.length? sameCat : dataset;
    const prices = pool.map(r=>r.price_per_kg).filter(Number.isFinite).sort((a,b)=>a-b);
    if(prices.length<3) return null;
    const pct=(arr,p)=> arr[Math.max(0, Math.min(arr.length-1, Math.round((p/100)*(arr.length-1))))];
    const p25=pct(prices,25), p50=pct(prices,50), p75=pct(prices,75);
    return { perKg:{p25,p50,p75}, total:{low:Math.round(p25*weightKg), mid:Math.round(p50*weightKg), high:Math.round(p75*weightKg)}, sample:pool.length };
  }

  // ---------- Dataset UI ----------
  const csvInp=$('#csv'), imgsInp=$('#imgs'), dsCount=$('#dsCount'), priceOut=$('#priceOut');
  function refreshDatasetCount(){ dsCount.textContent = 'Registros cargados: '+state.dataset.length; }
  function saveDataset(){ try{ localStorage.setItem('ganadopro.dataset', JSON.stringify(state.dataset)); }catch{} refreshDatasetCount(); refreshPricePanels(); }
  function loadDataset(){ try{ const s=localStorage.getItem('ganadopro.dataset'); if(s) state.dataset=JSON.parse(s)||[]; }catch{} refreshDatasetCount(); refreshPricePanels(); }
  loadDataset();
  csvInp.addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    try{ const text=await f.text(); const rows=parseCSV(text); state.dataset = rows; saveDataset(); log('CSV cargado: '+rows.length+' filas'); alert('Dataset cargado: '+rows.length+' registros'); }
    catch(err){ log('CSV error: '+(err.message||err)); alert('Error leyendo CSV'); }
  });
  $('#btnClear').onclick = ()=>{ state.dataset=[]; saveDataset(); };
  imgsInp.addEventListener('change', async (e)=>{
    const files=[...e.target.files]; if(!files.length) return;
    try{
      const imgs=await Promise.all(files.map(f=> toDataURL(f)));
      const resp = await fetch(state.apiBase+'/ocr-prices', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ images: imgs }) });
      const j = await resp.json();
      if(j?.rows && Array.isArray(j.rows)){ state.dataset = [...state.dataset, ...j.rows]; saveDataset(); alert('OCR agregado: '+j.rows.length+' filas'); }
      else { alert('OCR sin filas. Revisa la imagen o logs.'); }
    }catch(err){ log('OCR error: '+(err.message||err)); alert('Error en OCR'); }
  });

  // ---------- Pricing Panels ----------
  function refreshPricePanels(){
    const w = Number($('#priceWeight').value); const cat=$('#priceCategory').value; const sex=$('#priceSex').value;
    const est = estimatePrice(state.dataset, cat, sex, w);
    const set = (id,val)=> $('#'+id).textContent = Number.isFinite(val)? nf.format(val) : '–';
    if(!est){
      set('p_p25',NaN); set('p_p50',NaN); set('p_p75',NaN); set('p_low',NaN); set('p_mid',NaN); set('p_high',NaN); $('#p_sample').textContent='Muestra usada: –';
    }else{
      set('p_p25',est.perKg.p25); set('p_p50',est.perKg.p50); set('p_p75',est.perKg.p75);
      set('p_low',est.total.low); set('p_mid',est.total.mid); set('p_high',est.total.high);
      $('#p_sample').textContent='Muestra usada: '+est.sample;
    }
    // Secondary panel
    const w2=Number($('#w2').value), c2=$('#c2').value, s2=$('#s2').value;
    const e2 = estimatePrice(state.dataset, c2, s2, w2);
    if(!e2) priceOut.textContent='Carga un dataset en la pestaña “Dataset”.';
    else priceOut.textContent = `CRC/kg (P25,P50,P75): ${nf.format(e2.perKg.p25)}, ${nf.format(e2.perKg.p50)}, ${nf.format(e2.perKg.p75)} · Total: ${nf.format(e2.total.low)}–${nf.format(e2.total.high)} (mid ${nf.format(e2.total.mid)}). Muestra: ${e2.sample}`;
  }
  ['priceWeight','priceCategory','priceSex','w2','c2','s2'].forEach(id=> $('#'+id).addEventListener('input', refreshPricePanels));
  refreshPricePanels();

  // ---------- Analyze ----------
  async function analyze(){
    try{
      if(!state.file) return alert('Sube una imagen lateral primero.');
      log('Analizando...');
      const dataUrl = await toDataURL(state.file);
      const resp = await fetch(state.apiBase+'/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ imageDataUrl: dataUrl }) });
      const json = await resp.json();
      state.result = json; renderAnalysis(); showTab('reporte'); log('OK');
    }catch(err){ log('Analyze error: '+(err.message||err)); alert('Error analizando: '+(err?.message||err)); }
  }
  btnAnalyze.onclick = analyze; btnReanalyze.onclick = analyze;

  // ---------- Render Analysis ----------
  function scoreToBand(score){
    if(score>=85) return 'Excelente';
    if(score>=70) return 'Bueno';
    if(score>=55) return 'Regular';
    if(score>=40) return 'Malo';
    return 'Muy malo';
  }
  function renderAnalysis(){
    const r = state.result || {}; const m=r.morphology||{};
    $('#m_bodyLenToHeight').textContent = fmt(m.bodyLenToHeight);
    $('#m_bellyDepthRatio').textContent = fmt(m.bellyDepthRatio);
    $('#m_hockAngleDeg').textContent = fmt(m.hockAngleDeg);
    $('#m_toplineDeviation').textContent = fmt(m.toplineDeviation);
    $('#m_rumpSlope').textContent = fmt(m.rumpSlope);
    $('#m_bcs').textContent = fmt(Number(r.bcs)||NaN,1);

    const flags = Array.isArray(r.healthFlags)? r.healthFlags : [];
    const list = $('#flags'); list.innerHTML='';
    if(flags.length===0){ const li=document.createElement('li'); li.className='muted'; li.textContent='Sin observaciones'; list.appendChild(li); }
    else flags.forEach(t=>{ const li=document.createElement('li'); li.textContent = t.replaceAll('_',' '); list.appendChild(li); });

    const diseases = Array.isArray(r.diseaseFindings)? r.diseaseFindings : [];
    const dwrap = $('#diseasesWrap'); const dlist=$('#diseases'); dlist.innerHTML='';
    if(diseases.length>0){ dwrap.style.display='block'; diseases.forEach(t=>{ const li=document.createElement('li'); li.textContent = t; dlist.appendChild(li); }); } else { dwrap.style.display='none'; }

    const sex = sexSel.value; const cat=catSel.value; const age = Number(ageInp.value);
    const score = scoreFattening({ metrics:m, bcs:Number(r.bcs), sex, ageMonths:age, category:cat });
    const verdict = verdictCategory(score);
    $('#scoreBar').style.width = score+'%'; $('#scoreNum').textContent = String(score);
    const v = $('#verdict'); v.textContent = verdict.label; v.className = 'badge '+verdict.cls;
    $('#breedTop').textContent = r?.breedGuess?.[0]?.breed || '–';

    $('#analysisCard').style.display='block';

    // Report
    const rep = $('#reportContent');
    rep.innerHTML = `
      <div class="grid" style="grid-template-columns:2fr 1fr;gap:12px">
        <div class="grid">
          <div class="card">
            <div style="font-weight:600;margin-bottom:6px">Resumen del animal</div>
            <div class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr))">
              <div><div class="muted">Sexo</div><div style="font-weight:600">${sexSel.options[sexSel.selectedIndex].text}</div></div>
              <div><div class="muted">Categoría</div><div style="font-weight:600">${catSel.options[catSel.selectedIndex].text}</div></div>
              <div><div class="muted">Edad</div><div style="font-weight:600">${age} meses</div></div>
              <div><div class="muted">Peso</div><div style="font-weight:600">${wInp.value} kg</div></div>
            </div>
          </div>
          <div class="card">
            <div style="font-weight:600;margin-bottom:6px">Veredicto de engorda</div>
            <div class="badge ${verdict.cls}">${verdict.label}</div>
            <div class="muted" style="margin-top:6px">Score ${score}/100 — clasificación: Muy malo / Malo / Regular / Bueno / Excelente.</div>
          </div>
          <div class="card">
            <div style="font-weight:600;margin-bottom:6px">Estimación de precio</div>
            <div id="repPrice" class="muted">Ajusta en pestaña Precios.</div>
          </div>
        </div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:6px">Morfología (detalles)</div>
          <div class="stat"><div>Largo/Alzada</div><div>${fmt(m.bodyLenToHeight)}</div></div>
          <div class="stat"><div>Prof. abd./Alzada</div><div>${fmt(m.bellyDepthRatio)}</div></div>
          <div class="stat"><div>Ángulo corvejón (°)</div><div>${fmt(m.hockAngleDeg)}</div></div>
          <div class="stat"><div>Desv. de dorso</div><div>${fmt(m.toplineDeviation)}</div></div>
          <div class="stat"><div>Pend. de grupa</div><div>${fmt(m.rumpSlope)}</div></div>
          <div class="stat"><div>BCS</div><div>${fmt(Number(r.bcs)||NaN,1)}</div></div>
          <div class="muted" style="margin-top:6px">Banderas</div>
          <ul style="margin:6px 0 0 18px;list-style:disc">${(flags.length?flags.map(f=>`<li>${f.replaceAll('_',' ')}</li>`).join(''):'<li class="muted">Sin observaciones</li>')}</ul>
        </div>
      </div>
    `;
    refreshPricePanels();
  }

  // ---------- Buttons ----------
  $('#btnSaveApi').onclick = ()=>{ state.apiBase = $('#apiBase').value || '/api'; localStorage.setItem('ganadopro.apiBase', state.apiBase); $('#apiBaseCur').textContent = state.apiBase; alert('API base guardada: '+state.apiBase); };
  $('#btnAnalyze').disabled = true; $('#btnReanalyze').disabled = true;
  $('#btnAnalyze').onclick = analyze; $('#btnReanalyze').onclick = analyze;

  // ---------- Footer year ----------
  $('#year').textContent = new Date().getFullYear();
})();</script>
</body>
</html>
