<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GanadoPro • v39.4.1 (safe)</title>
<style>
:root{--bg:#0b1220;--ink:#e5e7eb;--muted:#9ca3af;--card:#0f172a;--line:#1f2937;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--brand:#22d3ee}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
.wrap{max-width:1120px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#22c55e,var(--brand));display:grid;place-items:center;color:#0b1220;font-weight:900}
.pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);background:#0b1325}
.row{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
.grid{display:grid;gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
.btn{background:#22c55e;color:#0b1220;border:none;border-radius:12px;padding:12px 16px;font-size:16px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
.btn.block{width:100%}
#dropArea.drag{outline:2px dashed var(--brand);outline-offset:4px}
.stat{display:flex;justify-content:space-between;padding:6px 0;border-top:1px dashed var(--line);font-size:14px}
.kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
.kpi>div{background:#0b1325;border:1px solid var(--line);border-radius:12px;padding:10px}
.lbl{color:var(--muted);font-size:12px}.val{font-weight:700}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1325;font-size:12px;color:#cbd5e1}
.ok{background:rgba(16,185,129,.15);border-color:#065f46;color:#a7f3d0}
.warn{background:rgba(245,158,11,.15);border-color:#92400e;color:#fde68a}
.bad{background:rgba(239,68,68,.15);border-color:#7f1d1d;color:#fecaca}
.bar{height:12px;background:#111827;border-radius:999px;overflow:hidden}.bar>i{display:block;height:12px;width:0;background:#ef4444;border-radius:999px}
.preview{max-width:100%;border-radius:12px;border:1px solid var(--line)}
details.diag{margin-left:auto}.diag pre{white-space:pre-wrap;background:#0b1325;border:1px dashed var(--line);padding:8px;border-radius:8px;color:#9ca3af;max-height:220px;overflow:auto}
small.dim{color:var(--muted)}
@media (max-width:900px){.row{grid-template-columns:1fr}.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}.btn.block{width:100%}}
@media (max-width:480px){header{gap:8px}.pill{padding:4px 8px;font-size:11px} .btn{padding:12px 14px;font-size:15px} .kpi>div{padding:8px} }
</style>
<script>
(function(){
  function byId(id){return document.getElementById(id)}
  function getApi(){try{return localStorage.getItem('ganadopro.apiBase')||'/api'}catch(e){return'/api'}}
  function saveApi(v){try{localStorage.setItem('ganadopro.apiBase',v)}catch(e){}}
  function setBadge(text,ok){var el=byId('health');if(!el)return;el.textContent=text;el.style.color=ok?'#86efac':'#fecaca'}
  async function health(){var base=getApi();var url=(base||'/api').replace(/\/$/,'')+'/health';try{const ctl=new AbortController();const t=setTimeout(()=>ctl.abort(),3500);const r=await fetch(url,{signal:ctl.signal});clearTimeout(t);const j=await r.json();setBadge(j.hasKey?('API: OK ('+(j.model||'')+')'):'API: sin llave',j.hasKey);byId('health').href=url}catch(e){setBadge('API: error',false);byId('health').href=url}}
  window.addEventListener('DOMContentLoaded',function(){
    var cfg=byId('cfgApi');if(cfg){cfg.onclick=function(){var cur=getApi();var val=prompt('Base de API (ej: /api o https://tuapp.vercel.app/api)',cur);if(!val)return;saveApi(val);health();alert('API base guardada: '+val)}};
    var rst=byId('resetApi');if(rst){rst.onclick=function(){saveApi('/api');alert('API base restablecida a /api');health();}};
    var file=byId('file');var btn=byId('btnUpload');if(btn&&file)btn.onclick=function(){file.click();};
    var drop=byId('dropArea');if(drop&&file){['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag')}));['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag')}));drop.addEventListener('drop',e=>{var fs=e.dataTransfer&&e.dataTransfer.files;if(fs&&fs.length){file.files=fs;file.dispatchEvent(new Event('change'))}})}
    health();
  });
})();
</script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">GP</div>
    <div>
      <div style="font-weight:800;font-size:20px">GanadoPro • v39.4.1 (safe)</div>
      <div style="color:var(--muted);font-size:12px">Doble validación IA • Anti-defaults • Re-medido hock/topline • Precios BCS</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <a class="pill" id="health" href="#">API: verificando…</a>
      <button id="cfgApi" class="pill" type="button">Configurar API</button>
      <button id="resetApi" class="pill" type="button">Reset API</button>
      <details class="diag pill"><summary>Diagnóstico</summary><pre id="diag"></pre></details>
    </div>
  </header>

  <div class="row">
    <div class="grid">
      <div class="card" id="dropArea">
        <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center">
          <button id="btnUpload" class="btn block" type="button">Elegir imagen</button>
          <input id="file" type="file" accept="image/*" style="display:none">
          <button id="btnReset" class="btn ghost" type="button">Reset</button>
          <div id="status" class="pill" style="grid-column:1/-1">Listo para cargar (puedes pegar o arrastrar imagen)</div>
        </div>
        <div id="imgWrap" style="margin-top:10px;display:none"><img id="preview" class="preview" alt="preview"></div>
      </div>

      <div id="report" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-weight:700">Informe técnico</div>
          <div id="src" style="font-size:12px;color:var(--muted)"></div>
        </div>
        <div class="kpi">
          <div><div class="lbl">Sexo</div><div id="r_sex" class="val">–</div></div>
          <div><div class="lbl">Categoría</div><div id="r_cat" class="val">–</div></div>
          <div><div class="lbl">Edad est.</div><div id="r_age" class="val">–</div></div>
          <div><div class="lbl">Peso est.</div><div id="r_w" class="val">–</div></div>
        </div>
        <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:6px">
          <div>
            <div style="font-weight:600;margin-bottom:6px">Morfología</div>
            <div class="stat"><div>Largo/Alzada</div><div id="m_body">–</div></div>
            <div class="stat"><div>Prof. abdomen/Alzada</div><div id="m_belly">–</div></div>
            <div class="stat"><div>Ángulo corvejón (°)</div><div id="m_hock">–</div></div>
            <div class="stat"><div>Desv. de dorso</div><div id="m_top">–</div></div>
            <div class="stat"><div>Pendiente de grupa</div><div id="m_rump">–</div></div>
          </div>
          <div>
            <div style="font-weight:600;margin-bottom:6px">Condición y salud</div>
            <div class="stat"><div>BCS (1–5)</div><div id="r_bcs">–</div></div>
            <div style="margin:6px 0;color:var(--muted)">Precaución principal</div>
            <div id="mainCaution" class="badge warn" style="display:none"></div>
            <div style="margin:6px 0;color:var(--muted)">Otras precauciones</div>
            <ul id="flags" style="margin:0 0 8px 18px;padding:0;list-style:disc"></ul>
          </div>
          <div>
            <div style="font-weight:600;margin-bottom:6px">Aptitud para engorda</div>
            <div class="bar"><i id="scoreBar"></i></div>
            <div style="font-size:12px;color:var(--muted);margin-top:6px">Score: <span id="scoreNum">–</span>/100</div>
            <div style="margin-top:6px">Veredicto: <span id="verdict" class="badge">–</span></div>
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">Raza/tipo: <span id="breedTop" style="color:#e5e7eb">–</span></div>
          </div>
        </div>
        <div style="font-weight:600;margin-top:8px;margin-bottom:6px">Resumen IA (explicación)</div>
        <div id="r_text" style="color:#d1d5db">—</div>
        <div style="font-weight:600;margin-top:8px;margin-bottom:6px">Auditoría IA</div>
        <div id="audit_text" style="color:#cbd5e1">—</div>
      </div>

      <div id="finance" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Rango CRC/kg sugerido</div>
          <div class="pill" id="fi_src">Fuente: subastas CR (2022–2025)</div>
        </div>
        <div class="kpi">
          <div><div class="lbl">Categoría usada</div><div id="fi_cat" class="val">–</div></div>
          <div><div class="lbl">Peso usado</div><div id="fi_w" class="val">–</div></div>
          <div><div class="lbl">CRC/kg (mín)</div><div id="fi_min" class="val">–</div></div>
          <div><div class="lbl">CRC/kg (máx)</div><div id="fi_max" class="val">–</div></div>
        </div>
        <div class="stat"><div>Precio recomendado por kg</div><div id="fi_rng" class="val">–</div></div>
        <small class="dim" id="fi_note">—</small>
      </div>
    </div>

    <aside class="grid">
      <div id="buyCard" class="card">
        <div style="font-weight:700;margin-bottom:6px">Rango para comprar (recomendado)</div>
        <div class="kpi">
          <div><div class="lbl">Decisión</div><div id="buy_dec" class="badge">–</div></div>
          <div><div class="lbl">CRC/kg</div><div id="buy_rng" class="val">–</div></div>
        </div>
        <div class="pill" id="buy_note">—</div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">“Hard gates” de NO compra</div>
        <ul style="color:var(--muted);margin:0 0 0 18px;list-style:disc">
          <li>Cojera/claudicación</li>
          <li>Emaciación marcada</li>
          <li>Diarrea o descarga nasal</li>
          <li>Heridas abiertas o bloat/timpanismo</li>
        </ul>
      </div>
    </aside>
  </div>
</div>

<script>
(function(){
  const $=(s)=>document.querySelector(s);
  const nf=new Intl.NumberFormat('es-CR');
  const state={ apiBase: localStorage.getItem('ganadopro.apiBase') || '/api' };
  const status=$('#status'); const preview=$('#preview'); const imgWrap=$('#imgWrap');
  const fileHidden=$('#file'); const diag=$('#diag'); function log(m){ if(!diag) return; diag.textContent+=(diag.textContent?'\\n':'')+m; }

  const PRICE_BASELINES={
    "ternero":{min:1300,max:1550,src:"2022–2025"},
    "novillo":{min:1400,max:1650,src:"2022–2025"},
    "toro":{min:1350,max:1600,src:"2022–2025"},
    "vaca":{min:1100,max:1350,src:"2022–2025"},
    "novilla":{min:1200,max:1500,src:"2022–2025"},
    "macho_criollo":{min:900,max:1100,src:"2022–2025"},
    "vaquilla":{min:800,max:950,src:"2022–2025"}
  };

  function normCat(s){
    s=(s||'').toLowerCase().trim();
    const map={
      "vaca_descarte":"vaca","vaca lechera":"vaca","vaca parida":"vaca",
      "vaquilla":"novilla","novilla":"novilla",
      "ternera":"ternero","becerro":"ternero","becerra":"ternero",
      "torete":"novillo","novillo gordo":"novillo",
      "macho criollo":"macho_criollo"
    };
    return map[s]||s;
  }

  function bcsMultipliers(bcs){
    if(!(Number.isFinite(bcs))) return [0.90,0.98];
    if(bcs<=2.2) return null;
    if(bcs<=2.6) return [0.85,0.92];
    if(bcs<=3.0) return [0.92,1.00];
    if(bcs<=3.4) return [0.90,0.96];
    return [0.82,0.90];
  }

  function dynamicCaps(cat, verdict, ageMonths){
    if(cat==='ternero'){ return {maxBueno:1800, maxExcelente:1800}; }
    if(cat==='novillo' || (cat==='toro' && Number.isFinite(ageMonths) && ageMonths<=24)){ return {maxBueno:1750, maxExcelente:1750}; }
    if(cat==='toro'){ return {maxBueno:1650, maxExcelente:1650}; }
    return {maxBueno:null, maxExcelente:null};
  }

  function colorFor(v){if(v<45)return'#ef4444';if(v<58)return'#f59e0b';if(v<72)return'#eab308';if(v<90)return'#10b981';return'#22c55e'}
  function flagToEs(f){const d={'hock_angle_closed':'Corvejón cerrado: vigilar','hock_angle_watch':'Ángulo de corvejón subóptimo','topline_curved':'Dorso curvado','steep_rump':'Grupa muy caída','underweight':'Condición corporal baja'};return d[f]||f.replaceAll('_',' ')}
  function badgeClass(v){if(v==='Excelente'||v==='Bueno')return'badge ok';if(v==='Regular')return'badge warn';return'badge bad'}
  function summarize(r){const m=r.morphology||{};const bcs=Number(r.bcs)||NaN;const bits=[];if(Number.isFinite(bcs)){if(bcs<2.3)bits.push('condición baja (BCS '+bcs.toFixed(1)+')');else if(bcs>3.8)bits.push('condición alta (BCS '+bcs.toFixed(1)+')');else bits.push('BCS adecuado ('+bcs.toFixed(1)+')');}if(Number.isFinite(m.bodyLenToHeight))bits.push('largo/alzada '+m.bodyLenToHeight.toFixed(2));if(Number.isFinite(m.hockAngleDeg))bits.push('corvejón ~'+Math.round(m.hockAngleDeg)+'°');if(Number.isFinite(m.toplineDeviation))bits.push('desv. dorso '+m.toplineDeviation.toFixed(2));return'Evaluación automática: '+bits.join(' · ')}

  function decideKgRange(verdict,cat,hardGates,bcs,ageMonths){
    if(hardGates && hardGates.length) return {base:null,min:null,max:null,note:'NO COMPRAR (hard gate: '+hardGates[0]+')'};
    const youngToro = (cat==='toro' && Number.isFinite(ageMonths) && ageMonths<=24);
    const priceCat = youngToro ? 'novillo' : cat;
    const base=PRICE_BASELINES[priceCat]||null;
    if(!base) return {base:null,min:null,max:null,note:'Sin base histórica para '+priceCat};
    const mf=bcsMultipliers(bcs);
    if(mf===null) return {base, min:null,max:null,note:'NO COMPRAR (BCS ≤ 2.2)'};
    let [mLow,mHigh]=mf;
    let minKg=Math.round(base.min*mLow);
    let maxKg=Math.round(base.max*mHigh);
    if(verdict==='Regular'){ minKg=Math.round(minKg*0.97); maxKg=Math.round(maxKg*0.94); }
    else if(verdict==='Bueno'){ maxKg=Math.round(maxKg*1.03); }
    else if(verdict==='Excelente'){ maxKg=Math.round(maxKg*1.08); }
    const caps = dynamicCaps(priceCat, verdict, ageMonths);
    if(verdict==='Bueno' && caps.maxBueno) maxKg = Math.min(maxKg, caps.maxBueno);
    if(verdict==='Excelente' && caps.maxExcelente) maxKg = Math.min(maxKg, caps.maxExcelente);
    let note = '';
    if(verdict==='Regular') note = 'Conservador (BCS/veredicto).';
    else if(verdict==='Bueno') note = 'Parte alta controlada.';
    else if(verdict==='Excelente') note = 'Premium controlado.';
    return {base, min:minKg, max:maxKg, note};
  }

  async function fileToDataURL(file){return await new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}
  async function compress(file,maxSide=1400,quality=0.8){const dataUrl=await fileToDataURL(file);const img=new Image();img.src=dataUrl;await new Promise((res,rej)=>{img.onload=res;img.onerror=()=>rej(new Error('No se pudo decodificar imagen'))});const scale=Math.min(1,maxSide/Math.max(img.naturalWidth,img.naturalHeight));const w=Math.round(img.naturalWidth*scale),h=Math.round(img.naturalHeight*scale);const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d',{alpha:false,desynchronized:true}).drawImage(img,0,0,w,h);const out=c.toDataURL('image/jpeg',quality);return{dataUrl:out};}

  async function callAnalyze(imageDataUrl){
    const url=(state.apiBase||'/api').replace(/\/$/,'')+'/analyze';
    const resp=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageDataUrl})});
    const txt=await resp.text(); if(!resp.ok){ throw new Error('API '+resp.status+': '+txt.slice(0,300)); }
    try{ return JSON.parse(txt); }catch{ throw new Error('JSON parse: '+txt.slice(0,300)); }
  }

  function paintFinance(r){
    const raw=(r.categoryGuess||'').toLowerCase();
    const cat=normCat(raw);
    const v=r.verdictBand||'–';
    const kg=decideKgRange(v,cat,r.auditHardGates||[], r.bcs, r.ageGuessMonths);
    const panel=$('#finance'); panel.style.display='block';
    $('#fi_cat').textContent=raw||'–';
    $('#fi_w').textContent=Number.isFinite(r.weightGuessKg)? nf.format(r.weightGuessKg)+' kg':'–';
    if(!kg.base){
      const label=(kg.min==null && (v==='Malo'||v==='Muy malo' || (r.auditHardGates||[]).length))?'NO COMPRAR':v;
      const buy=$('#buy_dec'); buy.textContent=label; buy.className=badgeClass(label==='NO COMPRAR'?'Malo':v);
      $('#buy_rng').textContent='—'; $('#buy_note').textContent=kg.note||'—';
      $('#fi_min').textContent='—'; $('#fi_max').textContent='—'; $('#fi_rng').textContent='—'; $('#fi_note').textContent='Sin base de referencia.';
      return;
    }
    const base=kg.base;
    $('#fi_min').textContent=nf.format(base.min);
    $('#fi_max').textContent=nf.format(base.max);
    const label=(kg.min==null)?'NO COMPRAR':v;
    const buy=$('#buy_dec'); buy.textContent=label; buy.className=badgeClass(label==='NO COMPRAR'?'Malo':v);
    const rngTxt=(kg.min==null)?'—':('₡'+nf.format(kg.min)+' – ₡'+nf.format(kg.max));
    $('#buy_rng').textContent=rngTxt;
    $('#buy_note').textContent=(kg.note||'') + ' · fuente '+base.src;
    $('#fi_rng').textContent=rngTxt;
    $('#fi_note').textContent='Rangos sensibles a BCS y categoría (editables en PRICE_BASELINES).';
  }

  async function analyze(file){
    try{
      status.textContent='Procesando imagen…';
      const comp=await compress(file,1400,0.8);
      status.textContent='Analizando…';
      const r=await callAnalyze(comp.dataUrl);

      $('#report').style.display='block';
      $('#src').textContent='Fuente: '+(r.source==='heuristic'?'heurística':('IA OpenAI · '+(r.auditPass?'doble validación':'simple')))+(r.note? ' — '+r.note : '');
      $('#r_sex').textContent=r.sex||'–'; $('#r_cat').textContent=r.categoryGuess||'–'; $('#r_age').textContent=Number.isFinite(r.ageGuessMonths)? (r.ageGuessMonths+' meses'):'–'; $('#r_w').textContent=Number.isFinite(r.weightGuessKg)? nf.format(r.weightGuessKg)+' kg':'–';
      $('#m_body').textContent=(r.morphology&&Number.isFinite(r.morphology.bodyLenToHeight))? r.morphology.bodyLenToHeight.toFixed(2):'–';
      $('#m_belly').textContent=(r.morphology&&Number.isFinite(r.morphology.bellyDepthRatio))? r.morphology.bellyDepthRatio.toFixed(2):'–';
      $('#m_hock').textContent=(r.morphology&&Number.isFinite(r.morphology.hockAngleDeg))? r.morphology.hockAngleDeg.toFixed(0):'–';
      $('#m_top').textContent=(r.morphology&&Number.isFinite(r.morphology.toplineDeviation))? r.morphology.toplineDeviation.toFixed(2):'–';
      $('#m_rump').textContent=(r.morphology&&Number.isFinite(r.morphology.rumpSlope))? r.morphology.rumpSlope.toFixed(2):'–';
      $('#r_bcs').textContent=Number.isFinite(r.bcs)? r.bcs.toFixed(1):'–';
      $('#breedTop').textContent=(r.breedGuess && r.breedGuess[0]?.breed) ? r.breedGuess[0].breed : '–';
      const sc=Number.isFinite(r.score)? r.score : 0; $('#scoreNum').textContent=sc; $('#scoreBar').style.width=sc+'%'; $('#scoreBar').style.background=colorFor(sc);
      const vb=r.verdictBand||'–'; const vEl=$('#verdict'); vEl.textContent=vb; vEl.className=badgeClass(vb);
      const flags=Array.isArray(r.healthFlags)? r.healthFlags:[]; const ul=$('#flags'); ul.innerHTML=''; const main=$('#mainCaution'); if(flags.length===0){ main.style.display='none'; const li=document.createElement('li'); li.style.color='var(--muted)'; li.textContent='Sin observaciones'; ul.appendChild(li); } else { const order=['underweight','hock_angle_closed','topline_curved','steep_rump','hock_angle_watch']; const sorted=[...flags].sort((a,b)=> order.indexOf(a)-order.indexOf(b)); main.style.display='inline-flex'; main.textContent=flagToEs(sorted[0]); sorted.slice(1).forEach(t=>{ const li=document.createElement('li'); li.textContent=flagToEs(t); ul.appendChild(li); }); }
      $('#r_text').innerHTML = (r.explanation||r.explanation_es) ? (r.explanation||r.explanation_es) : summarize(r);
      $('#audit_text').textContent = r.auditText || '—';

      paintFinance(r);
      status.textContent='Listo';
    }catch(err){ status.textContent='Error: '+(err&&err.message?err.message:err); log('ERR analyze: '+(err&&err.stack?err.stack:err)); }
  }

  function startWithFile(f){
    if(!f){ status.textContent='No seleccionaste imagen'; return; }
    if(!/^image\//i.test(f.type)){ status.textContent='Archivo no es imagen'; return; }
    const url=URL.createObjectURL(f); imgWrap.style.display='block'; preview.src=url; requestAnimationFrame(()=> URL.revokeObjectURL(url));
    status.textContent='Imagen seleccionada: '+(f.name||'(captura)');
    analyze(f);
  }

  document.getElementById('btnReset').onclick = ()=>{ preview.src=''; imgWrap.style.display='none'; document.getElementById('report').style.display='none'; document.getElementById('finance').style.display='none'; status.textContent='Listo para cargar (puedes pegar o arrastrar imagen)'; };
  fileHidden.addEventListener('change', (e)=> startWithFile(e.target.files && e.target.files[0]));
  window.addEventListener('paste', (e)=>{ const items=e.clipboardData?.items||[]; for(const it of items){ if(it.type && it.type.startsWith('image/')){ const f=it.getAsFile(); if(f) { startWithFile(f); break; } } } });
})();</script>
</body>
</html>
