<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GanadoPro • v45</title>
<style>
:root{--bg:#0b1220;--ink:#e5e7eb;--muted:#9ca3af;--card:#0f172a;--line:#1f2937}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
.wrap{max-width:980px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
.row{display:grid;grid-template-columns:1fr;gap:12px}
.btn{background:#22c55e;color:#0b1220;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.pill{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted)}
.preview{max-width:100%;border-radius:12px;border:1px solid var(--line);margin-top:8px}
pre{white-space:pre-wrap;background:#0b1325;border:1px dashed var(--line);border-radius:8px;padding:8px;color:#9ca3af;max-height:280px;overflow:auto}
.kv{display:grid;grid-template-columns:max-content 1fr;gap:6px 12px}
.kv b{color:#cbd5e1}
@media (min-width:900px){.row{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:0 0 8px 0">GanadoPro • v45</h1>
  <div class="pill" id="health">API: verificando…</div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="file" type="file" accept="image/*">
        <button id="analyze" class="btn">Analizar</button>
        <button id="reset" class="pill">Reset</button>
        <div id="status" class="pill" style="margin-left:auto">Listo</div>
      </div>
      <img id="preview" class="preview" style="display:none" alt="preview">
      <small style="color:var(--muted)">La imagen se envía a <code>/api/analyze</code> como JSON { imageDataUrl }.</small>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Resultados</div>
      <div id="out" class="kv">
        <b>Estado</b><span>Sin datos</span>
      </div>
      <details style="margin-top:8px"><summary>Respuesta cruda</summary><pre id="raw"></pre></details>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const statusEl=$('#status'), fileEl=$('#file'), img=$('#preview'), raw=$('#raw'), out=$('#out');

async function health(){
  try{
    const r=await fetch('/api/health'); const j=await r.json();
    $('#health').textContent = j.hasKey? ('API: OK ('+(j.model||'')+')') : 'API: sin llave';
  }catch(e){ $('#health').textContent='API: error'; }
}

async function fileToDataURL(file){
  const fr=new FileReader();
  return await new Promise((res,rej)=>{ fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
}

async function compress(file,maxSide=1400,quality=0.82){
  const url = await fileToDataURL(file);
  const imgEl=new Image(); imgEl.src=url;
  await new Promise((res,rej)=>{ imgEl.onload=res; imgEl.onerror=rej; });
  const scale=Math.min(1, maxSide/Math.max(imgEl.naturalWidth,imgEl.naturalHeight));
  const w=Math.round(imgEl.naturalWidth*scale), h=Math.round(imgEl.naturalHeight*scale);
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  c.getContext('2d',{alpha:false,desynchronized:true}).drawImage(imgEl,0,0,w,h);
  return c.toDataURL('image/jpeg',quality);
}

$('#reset').onclick = ()=>{ img.src=''; img.style.display='none'; out.innerHTML='<b>Estado</b><span>Sin datos</span>'; statusEl.textContent='Listo'; };

$('#analyze').onclick = async ()=>{
  try{
    if(!fileEl.files.length) return alert('Selecciona una imagen');
    statusEl.textContent='Procesando imagen…';
    const dataUrl = await compress(fileEl.files[0]);
    img.src=dataUrl; img.style.display='block';
    statusEl.textContent='Analizando…';
    const r = await fetch('/api/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ imageDataUrl: dataUrl }) });
    const text = await r.text();
    raw.textContent=text;
    let json=null;
    try{ json = JSON.parse(text); }catch{ throw new Error('La API no devolvió JSON. Revisa /api/analyze en Vercel.'); }
    statusEl.textContent='Listo';

    const m=json.morphology||{};
    out.innerHTML = `
      <b>Veredicto</b><span>${json.verdictBand||json.verdict||'—'} (score ${json.score??'—'})</span>
      <b>BCS</b><span>${json.bcs??'—'} / ${json.bcs9??'—'}</span>
      <b>Morfología</b><span>largo/alzada ${m.bodyLenToHeight??'—'}, abdomen/alzada ${m.bellyDepthRatio??'—'}, corvejón ${m.hockAngleDeg??'—'}°, dorso ${m.toplineDeviation??'—'}, grupa ${m.rumpSlope??'—'}</span>
      <b>Notas</b><span>${json.explanation||json.auditText||'—'}</span>`;
  }catch(e){
    statusEl.textContent='Error';
    out.innerHTML = `<b>Error</b><span>${(e && e.message) ? e.message : e}</span>`;
  }
};

health();
</script>
</body>
</html>
